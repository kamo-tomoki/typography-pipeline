<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Typographic Pipeline</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --pipe-color: rgba(255, 255, 255, 0.4);
        --text-color: #f0f0f0;
        --background-color: #1a1a1a;
        --highlight-color: #87cefa;
        --animation-duration: 1.5s;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: "Inter", "Noto Sans JP", sans-serif;
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 100vh;
        box-sizing: border-box;
        overflow: hidden;
      }

      /* --- ヘッダーと説明 --- */
      .header {
        text-align: center;
        flex-shrink: 0;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
      }

      .header p {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 0;
      }

      /* --- アニメーションと表示エリア --- */
      .main-content {
        position: relative;
        width: 100%;
        height: 100%;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* 土管（SVGパス）のスタイル */
      #pipe-path-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none; /* SVGがクリックなどを邪魔しないようにする */
      }

      #pipe-path {
        fill: none;
        stroke: var(--pipe-color);
        stroke-width: 40; /* 土管の太さ */
        stroke-linecap: round;
        stroke-linejoin: round;
        stroke-dasharray: 10 15; /* 点線にして少しデザイン性を出す */
        animation: flow 20s linear infinite;
      }

      @keyframes flow {
        from {
          stroke-dashoffset: 0;
        }
        to {
          stroke-dashoffset: 1000;
        }
      }

      /* アニメーション中の文字が一時的に入るコンテナ */
      #animation-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
      }

      /* アニメーションする文字のスタイル */
      .char-in-pipe {
        position: absolute; /* offset-pathを使うために必須 */
        color: var(--highlight-color);
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 0 0 10px var(--highlight-color);
        /* offset-pathはJavaScriptで動的に設定される */
        animation: move-along var(--animation-duration)
          cubic-bezier(0.4, 0, 0.8, 1) forwards;
      }

      @keyframes move-along {
        0% {
          offset-distance: 0%;
          transform: scale(0.5);
          opacity: 0;
        }
        10% {
          transform: scale(1);
          opacity: 1;
        }
        90% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          offset-distance: 100%;
          transform: scale(1.5);
          opacity: 0;
        }
      }

      /* 最終的に表示されるテキストのエリア */
      #output-area {
        font-size: 4rem;
        font-weight: 700;
        text-align: center;
        min-height: 100px;
        padding: 1rem;
        z-index: 0;
        line-height: 1.2;
        word-break: break-all;
      }

      #output-area .char {
        display: inline-block;
        animation: pop-in 0.3s ease-out;
      }

      @keyframes pop-in {
        from {
          transform: scale(0.5) translateY(20px);
          opacity: 0;
        }
        to {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>Typographic Pipeline</h1>
      <p>キーボードを叩いてみてください</p>
    </header>

    <div class="main-content">
      <!-- 文字が通る土管（SVGで描画） -->
      <svg
        id="pipe-path-svg"
        viewBox="0 0 900 400"
        preserveAspectRatio="xMidYMid meet"
      >
        <!-- このパスのd属性はJSによって設定される -->
        <path id="pipe-path" d="" />
      </svg>

      <!-- JSでアニメーション中の文字をここに追加 -->
      <div id="animation-container"></div>

      <!-- 土管から出てきた文字がここに表示される -->
      <div id="output-area"></div>
    </div>

    <script>
      const animationContainer = document.getElementById("animation-container");
      const outputArea = document.getElementById("output-area");
      const pipePath = document.getElementById("pipe-path");
      const pipePathSvg = document.getElementById("pipe-path-svg");

      let currentPathData = ""; // 現在のアニメーションパスを保持する変数

      // レスポンシブ対応のためにパスをJSで設定する関数
      const updatePipePath = () => {
        const width = window.innerWidth;
        if (width < 768) {
          // Mobile Path
          currentPathData = "M 50,250 C 100,100 250,400 350,250 L 400,250";
          pipePathSvg.setAttribute("viewBox", "0 0 450 500");
        } else {
          // Desktop Path
          currentPathData = "M 100,200 C 250,50 650,350 800,200 L 900,200";
          pipePathSvg.setAttribute("viewBox", "0 0 1000 400");
        }
        // SVGの土管自体のパスを更新
        pipePath.setAttribute("d", currentPathData);
      };

      // ページ読み込み時とウィンドウサイズ変更時にパスを更新
      window.addEventListener("resize", updatePipePath);
      document.addEventListener("DOMContentLoaded", updatePipePath);

      // キーボード入力のイベントリスナー
      document.addEventListener("keydown", (e) => {
        if (e.metaKey || e.ctrlKey || e.altKey) {
          return;
        }

        if (e.key === "Backspace") {
          const lastChar = outputArea.lastChild;
          if (lastChar) {
            lastChar.remove();
          }
          return;
        }

        if (e.key === "Enter") {
          const br = document.createElement("br");
          outputArea.appendChild(br);
          return;
        }

        if (e.key.length === 1) {
          // スペースも含めて処理
          if (e.key === " ") {
            const space = document.createElement("span");
            space.innerHTML = "&nbsp;";
            space.classList.add("char");
            outputArea.appendChild(space);
            return;
          }
          createAndAnimateCharacter(e.key);
        }
      });

      // 文字を生成してアニメーションさせる関数
      function createAndAnimateCharacter(char) {
        const charElement = document.createElement("div");
        charElement.textContent = char;
        charElement.className = "char-in-pipe";

        // ★修正点: アニメーションパスをJSで直接設定
        charElement.style.offsetPath = `path("${currentPathData}")`;

        animationContainer.appendChild(charElement);

        charElement.addEventListener("animationend", () => {
          charElement.remove();
          appendCharacterToOutput(char);
        });
      }

      // 表示エリアに文字を追加する関数
      function appendCharacterToOutput(char) {
        const outputChar = document.createElement("span");
        outputChar.textContent = char;
        outputChar.classList.add("char");
        outputArea.appendChild(outputChar);
      }
    </script>
  </body>
</html>
